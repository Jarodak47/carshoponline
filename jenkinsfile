pipeline {
    agent any
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Cloner le dépôt') {
            steps {
                script {
                    sh 'printenv'
                    echo 'Pulling the repository...' + env.BRANCH_NAME
                    checkout scm
                }
            }
        }
        stage('Construire les images Docker') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'main') {
                        app = docker.build("registry.gitlab.com/jarodak47/carshoponline:latest")
                    }else {
                        app = docker.build("registry.gitlab.com/jarodak47/carshoponline:${env.BRANCH_NAME}")
                    }
                }
            }
        }
        stage('Test') {
            steps {
                script {
                    echo 'Testing the application...'
                }
            }
        }
        stage('Déployer les services') {
            steps {
                script {
                    docker.withRegistry('https://registry.gitlab.com/jarodak47/carshoponline', 'gitlab-credentials') {
                        if (env.BRANCH_NAME == 'main') {
                            app.push('latest')
                        } else {
                            app.push(env.BRANCH_NAME)
                        }
                    }
                }
            }
        }
    }

}
